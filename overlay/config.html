<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Overlay Twitch Alerts Config</title>
    <link rel="stylesheet" href="./css/config.css">
</head>

<body>
    <div id="main-container">
        <div id="overlay">
            <div id="alert-container"></div>
        </div>

        <div id="config-panel">
            <h3>Configuração dos Cards</h3>

            <div id="event-configs"></div>

            <button class="saveButton" onclick="saveConfig()">💾 Salvar Configuração</button>

            <div id="overlay-url-container" style="margin-top:20px;">
                <label>Usar overlay no OBS, copie a URL:</label>
                <input type="text" id="overlay-url" readonly style="width:80%;" />
                <button id="copy-overlay-url">Copiar URL</button>
                <button id="open-overlay">Abrir Overlay</button>
            </div>
        </div>
    </div>

    <script>
        const events = {
            goal_begin: "📊 Meta iniciada",
            goal_progress: "📈 Progresso da meta",
            goal_end: "🏆 Meta finalizada",
            sub: "⭐ Novo inscrito",
            sub_gift: "🎁 Inscrito de presente",
            bits: "💎 Bits",
            raid: "🚀 Raid",
            follow: "👥 Follow"
        };

        const defaultConfigs = {
            goal_begin: {
                name: "META INICIADA",
                description: "Meta de inscritos",
                videoUrl: "https://static-cdn.jtvnw.net/default-alert-asset/v1/video/GoalStarted.webm"
            },
            goal_progress: {
                name: "PROGRESSO DA META",
                description: "Meta de inscritos",
                videoUrl: "https://static-cdn.jtvnw.net/default-alert-asset/v1/video/GoalStarted.webm"
            },
            goal_end: {
                name: "META FINALIZADA",
                description: "Meta de inscritos",
                videoUrl: "https://static-cdn.jtvnw.net/default-alert-asset/v1/video/GoalStarted.webm"
            },
            sub: {
                name: "NOVA INSCRIÇÃO",
                username: "Usuário",
                videoUrl: "https://static-cdn.jtvnw.net/default-alert-asset/v1/video/FirstTimeSub.webm",
                amountType: "Meses"
            },
            sub_gift: {
                name: "SUB DE PRESENTE",
                username: "Usuário",
                videoUrl: "https://static-cdn.jtvnw.net/default-alert-asset/v1/video/SmallCommunityGift.webm",
                amountType: "Quantidade"
            },
            bits: {
                name: "ENVIOU BITS",
                username: "Usuário",
                videoUrl: "https://static-cdn.jtvnw.net/default-alert-asset/v1/video/Cheering100Bits.webm",
                amountType: "Quantidade"
            },
            raid: {
                name: "NOVA RAID",
                username: "Usuário",
                videoUrl: "https://static-cdn.jtvnw.net/default-alert-asset/v1/video/Raid.webm",
                amountType: "Espectadores"
            },
            follow: {
                name: "NOVO SEGUIDOR",
                username: "Usuário",
                videoUrl: "https://static-cdn.jtvnw.net/default-alert-asset/v1/video/Follow.webm",
                amountType: "Seguidores"
            }
        };

        const showProgressEvents = ["goal_begin", "goal_progress", "goal_end", "follow"];
        let configs = JSON.parse(localStorage.getItem("alertConfigs") || "{}");

        const alertContainer = document.getElementById("alert-container");
        const eventConfigsContainer = document.getElementById("event-configs");

        Object.keys(events).forEach(ev => {
            configs[ev] = { ...defaultConfigs[ev], ...(configs[ev] || {}) };

            // Overlay
            const box = document.createElement("div");
            box.id = `alert-${ev}`;
            box.className = "alert-box";
            box.innerHTML = `
        <div class="text-container">
            <div class="image-container">
                <video class="main-image" autoplay muted loop>
                    <source class="main-video-source" src="" type="video/webm">
                </video>
            </div>
            <div class="banner-left">
                <span class="event-type">${configs[ev]}</span>
                <span class="username-container">Usuário</span>
            </div>
        </div>
        <div class="right-container">
            <span class="amount-type"></span>
            <div id="amount-container"></div>
            <span class="progress-text"></span>
            <div id="progress-container"><div id="progress-bar"></div></div>
        </div>
    `;
            alertContainer.appendChild(box);

            // Config
            const fs = document.createElement("fieldset");
            const lg = document.createElement("legend");
            lg.textContent = events[ev];
            fs.appendChild(lg);

            const fields = [
                { key: "bgColor", label: "Cor Fundo", type: "color" },
                { key: "cardWidth", label: "Largura (px)", type: "number" },
                { key: "cardHeight", label: "Altura (px)", type: "number" },
                { key: "eventTypeText", label: "Texto Event Type", type: "text" },
                { key: "eventTypeColor", label: "Cor Event Type", type: "color" },
                { key: "eventTypeSize", label: "Tamanho Event Type", type: "number" },
                { key: "usernameColor", label: "Cor Username", type: "color" },
                { key: "usernameSize", label: "Tamanho Username", type: "number" },
                { key: "amountTypeColor", label: "Cor Amount Type", type: "color" },
                { key: "amountTypeSize", label: "Tamanho Amount Type", type: "number" },
                ...(showProgressEvents.includes(ev) ? [
                    { key: "progressBarColor", label: "Cor Progress Bar", type: "color" },
                    { key: "progressTextColor", label: "Cor Progress Text", type: "color" }
                ] : []),
                { key: "videoUrl", label: "Vídeo/Imagem URL", type: "text" }
            ];


            fields.forEach(f => {
                const fieldDiv = document.createElement("div");
                fieldDiv.className = "config-field";

                const label = document.createElement("label");
                label.textContent = f.label;
                label.htmlFor = `${ev}-${f.key}`;

                const input = document.createElement(f.type === "text" ? "textarea" : "input");
                if (f.type !== "textarea") input.type = f.type;
                input.id = `${ev}-${f.key}`;
                input.value = configs[ev][f.key] || "";
                input.oninput = e => handleInputChange(e, ev, f.key);

                fieldDiv.appendChild(label);
                fieldDiv.appendChild(input);
                fs.appendChild(fieldDiv);
            });

            eventConfigsContainer.appendChild(fs);
            applyConfig(ev);
        });

        function handleInputChange(e, evKey, fieldKey) {
            if (!configs[evKey]) configs[evKey] = {};   // garante namespace por evento
            configs[evKey][fieldKey] = e.target.value;  // salva dentro do evento correto
            console.log("Config atualizada:", configs);
            applyConfig(evKey);
        }

        function applyConfig(evKey) {
            const c = configs[evKey] || {};
            const box = document.getElementById(`alert-${evKey}`);
            if (!box) return;

            box.style.backgroundColor = c.bgColor || "rgba(0,0,0,1)";
            box.style.width = (c.cardWidth || 400) + "px";
            box.style.height = (c.cardHeight || 60) + "px";

            const eventTypeEl = box.querySelector(".event-type");
            eventTypeEl.style.color = c.eventTypeColor || "#fff";
            eventTypeEl.style.fontSize = (c.eventTypeSize || 12) + "px";
            eventTypeEl.textContent = c.eventTypeText || c.name || events[evKey];

            const usernameEl = box.querySelector(".username-container");
            usernameEl.style.color = c.usernameColor || "#fff";
            usernameEl.style.fontSize = (c.usernameSize || 14) + "px";

            const amountTypeEl = box.querySelector(".amount-type");
            amountTypeEl.style.color = c.amountTypeColor || "#f0d90c";
            amountTypeEl.style.fontSize = (c.amountTypeSize || 12) + "px";

            const progressContainerEl = box.querySelector("#progress-container");
            const progressBarEl = box.querySelector("#progress-bar");
            const progressTextEl = box.querySelector(".progress-text");
            const amountContainer = box.querySelector("#amount-container");

            if (showProgressEvents.includes(evKey)) {
                amountContainer.style.display = "none";
                progressContainerEl.style.display = "block";
                progressBarEl.style.backgroundColor = c.progressBarColor || "#f0d90c";
                progressTextEl.style.color = c.progressTextColor || "#f0d90c";
                const current = c.currentAmount || 5;
                const target = c.targetAmount || 10;
                const percent = Math.min(100, (current / target) * 100);
                progressBarEl.style.width = percent + "%";
                progressTextEl.textContent = `${current} / ${target}`;

                if (evKey === "follow") amountTypeEl.textContent = "Seguidores";

            } else {
                progressContainerEl.style.display = "none";
                progressTextEl.textContent = "";
                amountContainer.style.display = "flex";
            }

            if (c.videoUrl) {
                const videoEl = box.querySelector(".main-video-source");
                videoEl.src = c.videoUrl;
                box.querySelector(".main-image").load();
            }
        }

        function saveConfig() {
            fetch('/configs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(configs)
            })
                .then(r => r.json())
                .then(() => {
                    alert('✅ Configurações salvas!');
                    localStorage.setItem("alertConfigs", JSON.stringify(configs));
                })
                .catch(err => console.error(err));
        }

        const overlayInput = document.getElementById("overlay-url");
        const copyBtn = document.getElementById("copy-overlay-url");
        const openBtn = document.getElementById("open-overlay");

        // Defina a URL real do overlay
        const overlayURL = `${window.location.origin}/overlay.html`;
        overlayInput.value = overlayURL;

        // Copiar URL para clipboard
        copyBtn.addEventListener("click", () => {
            overlayInput.select();
            overlayInput.setSelectionRange(0, 99999); // mobile
            navigator.clipboard.writeText(overlayInput.value)
                .then(() => alert("URL copiada!"))
                .catch(() => alert("Falha ao copiar URL."));
        });

        // Abrir overlay em nova aba
        openBtn.addEventListener("click", () => {
            window.open(overlayURL, "_blank");
        });
    </script>
</body>

</html>